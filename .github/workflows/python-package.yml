name: Set up Ubuntu SSH Server with Ngrok

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Set up Ngrok
        run: |
          mkdir -p ~/.ngrok2
          echo "authtoken: ${{ secrets.NGROK_AUTH_TOKEN }}" > ~/.ngrok2/ngrok.yml

      - name: Install Ngrok
        run: |
          sudo apt-get install unzip -y
          curl -s https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip -o ngrok.zip
          unzip ngrok.zip
          chmod +x ngrok

      - name: Start Ngrok
        run: |
          ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
          ./ngrok tcp 22 --log=stdout > ngrok.log &

      - name: Wait for Ngrok tunnel URL
        run: |
          sleep 10
          export NGROK_URL=$(cat ngrok.log | grep -oE "tcp://[0-9a-z.:]+")
          echo "Ngrok URL: $NGROK_URL"

      - name: Install OpenSSH server
        run: sudo apt-get install openssh-server -y

      - name: Configure SSH
        run: |
          sudo sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
          sudo service ssh restart

      - name: Generate SSH key
        run: ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa -q -N ""

      - name: Print public key
        run: cat ~/.ssh/id_rsa.pub

      - name: Print connection command
        run: echo "Run 'ssh -p 22 ubuntu@${{ env.NGROK_URL }}' to connect to the Ubuntu SSH server."

      - name: Print connection information
        run: echo "Connection Information: ${{ env.NGROK_URL }}"
